import{r as a,J as pe,j as e,Q as ue}from"./app-1TQRmdbV.js";import{B as j}from"./badge-CzRULw-a.js";import{B as A}from"./createLucideIcon-DWwUjqXg.js";import{C as b,a as w,b as S,c as v,d as q}from"./card-BAct_2yV.js";import{I as me}from"./input-MMDH--PJ.js";import{A as he}from"./app-layout-C5kaYaAQ.js";import{L as f,T as xe}from"./leaflet-CpBRcLrB.js";import ge from"./SuspendList-CeT_VtLv.js";import{D as fe}from"./download-CeWsSZoC.js";import{M as ee}from"./map-pin-7x-2i-iU.js";import{U as je}from"./breadcrumbs-LGzNgzJF.js";import{S as se}from"./search-DAVgrURI.js";import{L as W}from"./loader-circle-BCbXz62b.js";import"./index-DSPG1tRr.js";import"./index-DrblBIbr.js";import"./index-DlB68MZo.js";import"./app-logo-DotSD86T.js";import"./index-BN0-t6CM.js";import"./chevron-down-DygrjMWq.js";import"./file-text-s4U_5PDi.js";import"./trending-up-cHpR_S6l.js";import"./target-uKKW-0tC.js";import"./chevron-left-CHkmRqMs.js";import"./chevron-right-BlqDddEB.js";import"./index-DVN2uUiL.js";import"./index-ByE5jpk2.js";delete f.Icon.Default.prototype._getIconUrl;f.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});function Ve({customers:be,mapData:N,stats:C,filters:te}){var X;console.log("Initial mapData from props:",N.length),console.log("Stats from props:",C);const E=a.useRef(null),g=a.useRef(null),_=a.useRef(null),{auth:U}=pe().props,[D,O]=a.useState(!1),[u,Z]=a.useState(te.search||""),[F,B]=a.useState(N),[p,V]=a.useState(N),[o,H]=a.useState(null),[i,R]=a.useState(null),[k,$]=a.useState(!1),[T,Q]=a.useState(!1),[y,ne]=a.useState(5),[z,ae]=a.useState(0),oe=((X=U==null?void 0:U.user)==null?void 0:X.permissions)||[],G=(s,d)=>{let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>s(...t),d)}};a.useEffect(()=>{if(!E.current||g.current)return;const s=f.map(E.current,{scrollWheelZoom:!0,keyboard:!1,zoomAnimationThreshold:4,zoomAnimation:!0,fadeAnimation:!0,markerZoomAnimation:!0}).setView([-2.5,118],5);g.current=s,f.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(s),_.current=f.layerGroup().addTo(s),s.getContainer().addEventListener("wheel",t=>{t.stopPropagation()}),s.getContainer().addEventListener("touchstart",t=>{t.stopPropagation()}),s.getContainer().addEventListener("touchmove",t=>{t.stopPropagation()}),L(u),s.on("movestart",()=>{$(!0)}),s.on("zoomstart",()=>{$(!0)});const d=G(()=>{const t=s.getBounds(),l={north:t.getNorth(),south:t.getSouth(),east:t.getEast(),west:t.getWest()};H(l),$(!1)},2e3);s.on("moveend",d),s.on("zoomend",d),s.on("zoomend",()=>{const t=s.getZoom();ne(t),Math.abs(t-y)>2&&p.length>1e3&&L(u)});const n=s.getBounds();return H({north:n.getNorth(),south:n.getSouth(),east:n.getEast(),west:n.getWest()}),()=>{g.current&&(g.current.remove(),g.current=null)}},[]);const L=a.useCallback(async s=>{var d;O(!0);try{const n=z>1e3||p.length>1e3,t=new URLSearchParams;if(s&&t.append("search",s),n&&y<12){t.append("zoom",y.toString()),o&&(t.append("bounds[north]",o.north.toString()),t.append("bounds[south]",o.south.toString()),t.append("bounds[east]",o.east.toString()),t.append("bounds[west]",o.west.toString()));const r=await(await fetch(`/admin/suspend-subscription/clustered-map-data?${t}`)).json();console.log("Using clustered data:",r.cluster_count,"clusters for",r.total_points,"points");const m=[];r.clusters.forEach(c=>{c.items.forEach(x=>{m.push({id:x.id,customer_id:"",customer_name:x.customer_name,customer_phone:"",customer_email:"",subscription_id:x.id,subscription_address:x.address,subscription_description:"",subscription_status:"SUSPEND",serv_id:x.serv_id,lat:c.lat,lng:c.lng,coordinates:`${c.lat},${c.lng}`,created_at:"",suspend_at:null})})}),V(m),B(m),I(m),Q(!0)}else{t.append("all","true"),t.append("limit","5000"),console.log("Loading all map data with params:",t.toString());const r=await(await fetch(`/admin/suspend-subscription/map-data?${t}`)).json();console.log("Received data:",r),console.log("Total records received:",((d=r.data)==null?void 0:d.length)||0),console.log("Total in DB:",r.total_in_db||"unknown");const m=r.data||[];r.total_in_db&&ae(r.total_in_db);const c=m.length<N.length?N:m;console.log("Using data:",c.length>m.length?"props data":"fetched data"),console.log("Final total records:",c.length),V(c),B(c),I(c),Q(!1)}}catch(n){console.error("Error loading all map data:",n)}finally{O(!1)}},[y,o,z]),M=a.useCallback(s=>!s||p.length===0?p:p.filter(n=>!n.lat||!n.lng?!1:n.lat>=s.south&&n.lat<=s.north&&n.lng>=s.west&&n.lng<=s.east),[p]),J=a.useCallback(G(s=>{L(s)},300),[L]),K=a.useCallback(s=>{J(s)},[J]),I=a.useCallback(s=>{if(!_.current||!g.current)return;_.current.clearLayers();const d=T?1e3:3e3,n=s.slice(0,d);console.log(`Displaying ${n.length} of ${s.length} total markers (cluster mode: ${T})`);const t=s.length>2e3?200:100;let l=0;const r=()=>{var c;const m=Math.min(l+t,n.length);for(let x=l;x<m;x++){const h=n[x];if(h.lat&&h.lng){const Y=i&&i.id===h.id,le=Y?"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png":"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",ce=Y?"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png":"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",de=f.marker([h.lat,h.lng],{icon:f.icon({iconUrl:le,iconRetinaUrl:ce,shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})}).bindPopup(`
                            <div class="p-2 max-w-xs">
                                <h3 class="font-semibold text-sm">${h.customer_name}</h3>
                                <p class="text-xs text-gray-600 mb-1"><strong>Alasan : </strong>${h.subscription_description||"No description"}</p>
                                <p class="text-xs"><strong>Service ID:</strong> ${h.serv_id}</p>
                                <p class="text-xs"><strong>Address:</strong> ${h.subscription_address}</p>
                                <p class="text-xs"><strong>Suspend:</strong> ${h.suspend_at||"N/A"}</p>
                            </div>
                        `,{maxWidth:300,className:"custom-popup"}).on("click",()=>{R(h)});(c=_.current)==null||c.addLayer(de)}}l=m,l<n.length&&(typeof window.requestIdleCallback=="function"?requestIdleCallback(r,{timeout:50}):requestAnimationFrame(r))};n.length>0&&(typeof window.requestIdleCallback=="function"?requestIdleCallback(r,{timeout:50}):requestAnimationFrame(r))},[i]),P=a.useCallback(s=>{Z(s),K(s)},[K]),re=a.useCallback((s,d,n)=>{g.current&&(g.current.setView([s,d],16),R(n))},[]);a.useEffect(()=>{if(o&&!k){const s=M(o);B(s)}},[o,M,k]),a.useEffect(()=>{if(p.length>0){const s=o&&!k?M(o):p;I(s)}},[i,p,I,o,M,k]);const ie=async()=>{try{const s=new URLSearchParams;u&&s.append("search",u),o&&(s.append("bounds[north]",o.north.toString()),s.append("bounds[south]",o.south.toString()),s.append("bounds[east]",o.east.toString()),s.append("bounds[west]",o.west.toString())),s.append("format","csv");const n=await(await fetch(`/admin/suspend-subscription/export?${s}`)).blob(),t=window.URL.createObjectURL(n),l=document.createElement("a");l.href=t,l.download=`suspended_subscriptions_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(t),document.body.removeChild(l)}catch(s){console.error("Export failed:",s)}};return e.jsxs(he,{children:[e.jsx(ue,{title:"Suspend Subscription"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Suspend Subscription"}),e.jsx("p",{className:"text-muted-foreground",children:"View and manage suspend subscriptions with location mapping"})]}),oe.includes("export-data")&&e.jsxs(A,{onClick:ie,variant:"outline",children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"Export Data"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(b,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"text-sm font-medium",children:"Total suspended"}),e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:C.total_suspended.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All suspended subscriptions"})]})]}),e.jsxs(b,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"text-sm font-medium",children:"With Coordinates"}),e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:C.with_coordinates.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Can be shown on map"})]})]}),e.jsxs(b,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"text-sm font-medium",children:"Without Coordinates"}),e.jsx(je,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(v,{children:[e.jsx("div",{className:"text-2xl font-bold",children:C.without_coordinates.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Location data missing"})]})]})]}),e.jsxs(b,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Search suspended Subscriptions"}),e.jsx(q,{children:"Search by customer name, phone, email, subscription ID, or service ID"})]}),e.jsxs(v,{children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(se,{className:"absolute top-2.5 left-2 h-4 w-4 text-muted-foreground"}),e.jsx(me,{placeholder:"Search customers or subscriptions...",value:u,onChange:s=>Z(s.target.value),onKeyDown:s=>{s.key==="Enter"&&P(u)},className:"pl-8"})]}),e.jsx(A,{onClick:()=>P(u),disabled:D,children:D?e.jsx(W,{className:"h-4 w-4 animate-spin"}):e.jsx(se,{className:"h-4 w-4"})}),u&&e.jsx(A,{variant:"outline",onClick:()=>P(""),children:"Clear"})]}),u&&e.jsx("div",{className:"mt-2",children:e.jsxs(j,{variant:"secondary",children:['Searching for: "',u,'"']})})]})]}),i&&e.jsxs(b,{children:[e.jsxs(w,{children:[e.jsx(S,{children:"Selected Location Details"}),e.jsx(q,{children:"Information for the selected marker"})]}),e.jsxs(v,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:"Customer Information"}),e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",i.customer_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",i.customer_phone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",i.customer_email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status :"})," ",e.jsx(j,{variant:"warning",children:i.subscription_status})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:"Subscription Details"}),e.jsxs("p",{children:[e.jsx("strong",{children:"Service ID:"})," ",i.serv_id]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Description:"})," ",i.subscription_description||"N/A"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Address:"})," ",i.subscription_address]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Coordinates:"})," ",i.coordinates]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Suspended:"})," ",i.suspend_at||"N/A"]})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(A,{variant:"outline",onClick:()=>R(null),children:"Close Details"})})]})]}),e.jsxs(b,{children:[e.jsx(w,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(S,{children:"Location Map"}),e.jsx(q,{children:D?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(W,{className:"h-3 w-3 animate-spin"}),"Loading map data..."]}):k?e.jsxs("span",{className:"flex items-center gap-1 text-orange-600",children:[e.jsx(ee,{className:"h-3 w-3"}),"Map is moving... table will update in 2 seconds"]}):`Showing ${F.length} of ${p.length} suspended subscriptions`})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{variant:"outline",children:[z||p.length," total in DB"]}),e.jsxs(j,{variant:"secondary",children:[p.length," cached"]}),e.jsxs(j,{variant:"default",children:[F.length," visible"]}),T&&e.jsx(j,{variant:"destructive",children:"Clustered"})]})]})}),e.jsxs(v,{className:"relative",children:[e.jsx("div",{ref:E,className:"h-[800px] rounded-lg border",style:{minHeight:"800px",touchAction:"none"}}),D&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center rounded-lg bg-white/50",children:e.jsxs("div",{className:"flex items-center gap-2 rounded-lg bg-white p-4 shadow-lg",children:[e.jsx(W,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"Loading markers..."})]})})]})]}),e.jsx(ge,{initialSearch:u,mapBounds:o,onLocationClick:re})]})]})}export{Ve as default};
