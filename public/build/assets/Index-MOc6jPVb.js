import{r as n,j as e,Q as re}from"./app-DydvzzJZ.js";import{A as ie,a as le}from"./alert-OCX0MC9z.js";import{a as ne,B as b}from"./createLucideIcon-B8g3hsTz.js";import{C as F,a as R,b as I,d as M,c as L}from"./card-Cr_lE87H.js";import{I as oe}from"./input-D_920G0P.js";import{L as V}from"./label-DZiE_o3I.js";import{P as ce}from"./progress-DNztFiFd.js";import{A as de,D as X}from"./app-layout-CLVRSiwA.js";import{C as me}from"./circle-alert-Cq7eg9NA.js";import{C as H}from"./clock-BC_WsjUJ.js";import{X as G}from"./index-eNSZ6-Jd.js";import{F as A}from"./file-text-CsWsNYoU.js";import{C as pe}from"./circle-check-big-cmi2138m.js";import{T as W}from"./triangle-alert-BRTphUve.js";import"./index-BrIE_P40.js";import"./index-B-nnM25K.js";import"./breadcrumbs-DRQFlL8O.js";import"./app-logo-C6-ohmDo.js";import"./index-DKGcT16G.js";import"./index-Dht5mKOf.js";import"./index-D1GKDT0r.js";import"./index-BQZ5xCP9.js";import"./index-Dw58XjTL.js";import"./chevron-right-Vcumhzzq.js";import"./chevron-down-BiiGhmOA.js";import"./target-BQ2HF36K.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]],Y=ne("Upload",ue),xe=[{title:"Dashboard",href:"/dashboard"},{title:"Database Import",href:"/admin/database-import"}];function qe(){var K;const[p,f]=n.useState(0),[_,j]=n.useState(""),[r,g]=n.useState(null),[h,O]=n.useState(null),[y,w]=n.useState(!1),[B,k]=n.useState(null),[C,q]=n.useState(null),[Q,d]=n.useState([]),[x,T]=n.useState(null),[P,U]=n.useState(!1),[S,z]=n.useState({customers:[],subscriptions:[]}),E=n.useRef(null),v=async()=>{var t;let s=(t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.content;if(!s)try{const a=await fetch("/admin/database-import",{method:"GET",headers:{Accept:"text/html"}});if(a.ok){const o=(await a.text()).match(/<meta name="csrf-token" content="([^"]+)"/);if(o){s=o[1];const i=document.querySelector('meta[name="csrf-token"]');i&&(i.content=s)}}}catch(a){console.warn("Failed to refresh CSRF token:",a)}if(!s)throw new Error("CSRF token not found. Please refresh the page and try again.");return s},Z=n.useCallback(s=>{var a,l;const t=(a=s.target.files)==null?void 0:a[0];if(t){if(((l=t.name.split(".").pop())==null?void 0:l.toLowerCase())!=="sql"){alert("Please select a valid SQL file (.sql extension required)"),s.target.value="";return}if(t.size>157286400){alert("File size must not exceed 150MB"),s.target.value="";return}O(t),g(null),f(0),j(""),k(null),d([])}},[]),J=n.useCallback(async(s,t)=>{try{U(!0);const a=await v(),l=await fetch("/admin/database-import/skipped-records",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,Accept:"application/json"},body:JSON.stringify({progress_id:s,type:t})});if(!l.ok)throw new Error("Failed to fetch skipped records");const o=await l.json();o.success&&z(i=>({...i,[t]:o.data||[]}))}catch(a){console.error("Error fetching skipped records:",a)}finally{U(!1)}},[v]),D=n.useCallback(async s=>{try{const t=await v(),a=await fetch("/admin/database-import/progress",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t,Accept:"application/json"},body:JSON.stringify({progress_id:s})});if(!a.ok)throw new Error("Failed to fetch progress");const l=await a.json(),o=Math.max(0,Math.min(100,l.percentage));f(o),j(l.message),d(i=>{const c=`${new Date().toLocaleTimeString()}: ${l.message}`,N=i[i.length-1],u=N?N.split(": ").slice(1).join(": "):"";return l.message!==u?[...i,c]:i}),l.percentage>=0&&l.percentage<100?setTimeout(()=>D(s),1e3):l.percentage===100?(d(i=>[...i,`${new Date().toLocaleTimeString()}: Fetching final results...`]),setTimeout(async()=>{try{let i=3,m=0,c=null;for(;m<i;){m++,d(u=>[...u,`${new Date().toLocaleTimeString()}: Fetching final results (attempt ${m}/${i})...`]);const N=await fetch("/admin/database-import/results",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t,Accept:"application/json"},body:JSON.stringify({progress_id:s})});if(console.log(`Results API response status (attempt ${m}):`,N.status),N.ok&&(c=await N.json(),console.log(`Results response (attempt ${m}):`,c),c.success&&c.data)){console.log("Setting result to:",c.data),g(c.data),d(u=>[...u,`${new Date().toLocaleTimeString()}: Results retrieved successfully!`]);break}if(m<i){const u=m*2e3;d($=>[...$,`${new Date().toLocaleTimeString()}: Results not ready, waiting ${u/1e3} seconds...`]),await new Promise($=>setTimeout($,u))}}(!(c!=null&&c.success)||!(c!=null&&c.data))&&(console.log("Results not available after multiple attempts, using placeholder"),d(u=>[...u,`${new Date().toLocaleTimeString()}: Warning: Results not available after multiple attempts`]),g({progress_id:s,customers:{imported:0,skipped:0,total:0},subscriptions:{imported:0,skipped:0,total:0}}))}catch(i){console.error("Failed to fetch results:",i),d(c=>[...c,`${new Date().toLocaleTimeString()}: Warning: Could not fetch detailed results`]),console.log("Creating placeholder result due to exception"),g({progress_id:s,customers:{imported:0,skipped:0,total:0},subscriptions:{imported:0,skipped:0,total:0}})}w(!1),console.log("Import process completed, uploading set to false, progress:",l.percentage)},2e3)):l.percentage<0&&(k(l.message),w(!1))}catch(t){console.error("Progress tracking error:",t),s&&setTimeout(()=>D(s),2e3)}},[v]),ee=n.useCallback(async()=>{if(h){w(!0),console.log("Starting upload process, uploading set to true"),f(0),j("Starting import..."),g(null),k(null),d([`${new Date().toLocaleTimeString()}: Import started...`]);try{const s=new FormData;s.append("sql_file",h);const t=await v();f(5),j("Uploading file..."),d(i=>[...i,`${new Date().toLocaleTimeString()}: Uploading SQL file...`]);const a=await fetch("/admin/database-import/upload",{method:"POST",headers:{"X-CSRF-TOKEN":t,Accept:"application/json"},body:s}),l=a.clone();let o;try{o=await a.json()}catch{const m=await l.text();throw console.error("Failed to parse JSON response:",m),a.status===419?new Error("Session expired. Please refresh the page and try again."):a.status===403?new Error("Access denied. You may not have permission to import databases."):a.status===422?new Error("Validation failed. Please check your file and try again."):new Error(`Server returned invalid JSON response. Status: ${a.status}. Please check the server logs for more details.`)}if(a.ok&&o.success)o.data.progress_id?(q(o.data.progress_id),d(i=>[...i,`${new Date().toLocaleTimeString()}: File uploaded successfully, starting import process...`]),await D(o.data.progress_id)):(g(o.data),f(100),j("Import completed successfully!"),d(i=>[...i,`${new Date().toLocaleTimeString()}: Import completed successfully!`]),w(!1));else throw new Error(o.message||"Import failed")}catch(s){const t=s.message||"Import failed";k(t),f(0),j("Import failed"),d(a=>[...a,`${new Date().toLocaleTimeString()}: Error - ${t}`]),w(!1)}}},[h,D]),se=n.useCallback(()=>{O(null),w(!1),f(0),j(""),g(null),k(null),q(null),d([]),T(null),z({customers:[],subscriptions:[]}),E.current&&(clearInterval(E.current),E.current=null);const s=document.getElementById("sql-file");s&&(s.value="")},[]),te=s=>{if(s===0)return"0 Bytes";const t=1024,a=["Bytes","KB","MB","GB"],l=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,l)).toFixed(2))+" "+a[l]},ae=()=>{window.location.href="/admin/reports"};return n.useEffect(()=>{console.log("Result state changed:",r)},[r]),e.jsxs(de,{breadcrumbs:xe,children:[e.jsx(re,{title:"Database Import"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Database Import"}),e.jsx("p",{className:"text-muted-foreground",children:"Import customers and subscriptions from SQL file"})]}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs(F,{children:[e.jsxs(R,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5"}),"Upload SQL File"]}),e.jsx(M,{children:"Select a SQL file containing customers and subscriptions data (max 150MB)"})]}),e.jsxs(L,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"sql-file",children:"SQL File"}),e.jsx(oe,{id:"sql-file",type:"file",accept:".sql",onChange:Z,disabled:y}),h&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Selected: ",h.name," (",te(h.size),")"]})]}),B&&e.jsxs(ie,{variant:"destructive",className:"dark:border-red-800 dark:bg-red-900 dark:text-red-100",children:[e.jsx(me,{className:"h-4 w-4 dark:text-red-300"}),e.jsx(le,{className:"dark:text-red-100",children:B})]}),y&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Import Progress"}),e.jsxs("span",{className:"font-medium",children:[p,"%"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ce,{value:p,className:`h-3 w-full ${p<0?"bg-red-100":p<40?"bg-blue-100":p<70?"bg-green-100":p<100?"bg-purple-100":"bg-emerald-100"}`}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground",children:[e.jsx("span",{className:p>=10?"text-green-600":"",children:"Parse File"}),e.jsx("span",{className:p>=40?"text-green-600":"",children:"Import Customers"}),e.jsx("span",{className:p>=70?"text-green-600":"",children:"Import Subscriptions"}),e.jsx("span",{className:p>=100?"text-green-600":"",children:"Complete"})]})]}),_&&e.jsxs("div",{className:"flex items-center gap-2 rounded bg-blue-50 p-2 text-sm",children:[e.jsx(H,{className:"h-4 w-4 flex-shrink-0 text-blue-600"}),e.jsx("span",{className:"text-blue-800",children:_})]})]}),Q.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(V,{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(H,{className:"h-4 w-4"}),"Import Activity Log"]}),e.jsxs("div",{className:"max-h-40 space-y-1 overflow-y-auto rounded-md border bg-muted/30 p-3",children:[Q.map((s,t)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs",children:[e.jsxs("span",{className:"flex-shrink-0 font-mono text-blue-600",children:[s.split(": ")[0],":"]}),e.jsx("span",{className:"text-muted-foreground",children:s.split(": ").slice(1).join(": ")})]},t)),e.jsx("div",{ref:s=>s==null?void 0:s.scrollIntoView({behavior:"smooth"})})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(b,{onClick:ee,disabled:!h||y,className:"flex-1",children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),y?"Importing...":"Start Import"]}),(h||r)&&e.jsxs(b,{variant:"outline",onClick:se,disabled:y,children:[e.jsx(G,{className:"mr-2 h-4 w-4"}),"Reset"]})]})]})]}),e.jsxs(F,{children:[e.jsx(R,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5"}),"Panduan Impor"]})}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"mb-2 font-medium",children:"Persyaratan File"}),e.jsxs("ul",{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsx("li",{children:"• Format file SQL (.sql)"}),e.jsx("li",{children:"• Ukuran file maksimum: 150MB"}),e.jsx("li",{children:"• Harus berisi perintah INSERT"}),e.jsx("li",{children:"• Disarankan menggunakan encoding UTF-8"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"mb-2 font-medium",children:"Tabel yang Diharapkan"}),e.jsxs("ul",{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsxs("li",{children:["• ",e.jsx("code",{children:"customers"})," - Data master pelanggan"]}),e.jsxs("li",{children:["• ",e.jsx("code",{children:"subscriptions"})," - Data langganan"]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"mb-2 font-medium",children:"Proses Import"}),e.jsxs("ul",{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsx("li",{children:"• Pelanggan diimpor terlebih dahulu"}),e.jsx("li",{children:"• Langganan akan dikaitkan ke pelanggan"}),e.jsx("li",{children:"• Data duplikat akan diperbarui"}),e.jsx("li",{children:"• Data tidak valid akan dilewati"})]})]})]})]})]}),r&&e.jsxs(F,{children:[e.jsxs(R,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-green-600"}),"Import Results"]}),e.jsxs(M,{children:["Import completed at ",new Date().toLocaleString()]})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-blue-600"}),e.jsx("h4",{className:"font-medium",children:"Customers"})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total records found:"}),e.jsx("span",{className:"font-medium",children:r.customers.total})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Successfully imported:"}),e.jsx("span",{className:"font-medium text-green-600",children:r.customers.imported})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Skipped/Failed:"}),e.jsx("span",{className:"font-medium text-yellow-600",children:r.customers.skipped})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"Success Rate:"}),e.jsxs("span",{className:"font-medium text-blue-600",children:[r.customers.total>0?Math.round(r.customers.imported/r.customers.total*100):0,"%"]})]})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-purple-600"}),e.jsx("h4",{className:"font-medium",children:"Subscriptions"})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total records found:"}),e.jsx("span",{className:"font-medium",children:r.subscriptions.total})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Successfully imported:"}),e.jsx("span",{className:"font-medium text-green-600",children:r.subscriptions.imported})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Skipped/Failed:"}),e.jsx("span",{className:"font-medium text-yellow-600",children:r.subscriptions.skipped})]}),e.jsx("div",{className:"mt-2 border-t pt-2",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:"Success Rate:"}),e.jsxs("span",{className:"font-medium text-blue-600",children:[r.subscriptions.total>0?Math.round(r.subscriptions.imported/r.subscriptions.total*100):0,"%"]})]})})]})]})]}),(r.customers.skipped>0||r.subscriptions.skipped>0)&&e.jsx("div",{className:"mt-6 rounded-lg border border-yellow-200 bg-yellow-50 p-4",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(W,{className:"mt-0.5 h-5 w-5 text-yellow-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h5",{className:"font-medium text-yellow-800",children:"Some records were skipped"}),e.jsx("p",{className:"mt-1 text-sm text-yellow-700",children:"Records may have been skipped due to:"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-sm text-yellow-700",children:[e.jsx("li",{children:"• Invalid customer references"}),e.jsx("li",{children:"• Data validation errors"}),e.jsx("li",{children:"• Database constraint violations"}),e.jsx("li",{children:"• Duplicate IDs"})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[r.customers.skipped>0&&e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>{T("customers"),C&&S.customers.length===0&&J(C,"customers")},disabled:P,className:"border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:["View Skipped Customers (",r.customers.skipped,")"]}),r.subscriptions.skipped>0&&e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>{T("subscriptions"),C&&S.subscriptions.length===0&&J(C,"subscriptions")},disabled:P,className:"border-yellow-300 text-yellow-800 hover:bg-yellow-100",children:["View Skipped Subscriptions (",r.subscriptions.skipped,")"]})]})]})]})}),e.jsxs("div",{className:"mt-6 flex justify-center gap-3",children:[e.jsxs(b,{onClick:ae,children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"View Reports"]}),e.jsxs(b,{variant:"outline",onClick:()=>window.location.reload(),children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),"Import Another File"]})]})]})]}),x&&e.jsxs(F,{className:"mt-6",children:[e.jsxs(R,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5 text-yellow-600"}),"Skipped ",x==="customers"?"Customers":"Subscriptions"," Details"]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>T(null),className:"h-8 w-8 p-0",children:e.jsx(G,{className:"h-4 w-4"})})]}),e.jsx(M,{children:"Details of records that were skipped during import with reasons"})]}),e.jsx(L,{children:P?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading skipped records..."})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing skipped ",x," records (",S[x].length," of"," ",((K=r==null?void 0:r[x])==null?void 0:K.skipped)||0," total)"]}),S[x].length>0?e.jsx("div",{className:"max-h-96 space-y-3 overflow-y-auto",children:S[x].map((s,t)=>e.jsxs("div",{className:"rounded-lg border border-red-200 bg-red-50 p-3",children:[e.jsxs("div",{className:"mb-2 flex items-start justify-between",children:[e.jsx("div",{className:"font-medium text-red-800",children:x==="customers"?e.jsxs(e.Fragment,{children:["Customer: ",s.customer_name||s.customer_id]}):e.jsxs(e.Fragment,{children:["Subscription: ",s.subscription_id]})}),e.jsx("span",{className:"rounded bg-red-100 px-2 py-1 text-xs text-red-700",children:s.reason})]}),e.jsxs("div",{className:"text-sm text-red-700",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Customer ID:"})," ",s.customer_id]}),s.subscription_id&&e.jsxs("div",{children:[e.jsx("strong",{children:"Subscription ID:"})," ",s.subscription_id]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Details:"})," ",s.details]})]})]},t))}):e.jsxs("div",{className:"p-8 text-center text-muted-foreground",children:["No detailed records available for skipped ",x]})]})})]})]})]})}export{qe as default};
