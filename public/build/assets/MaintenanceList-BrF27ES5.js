import{r as n,j as e}from"./app-DOxJ3Wnc.js";import{B}from"./badge-vsPzlwjZ.js";import{B as o,c as P}from"./createLucideIcon-DZIc7J5K.js";import{C as H,a as X,b as J,d as K,c as oe}from"./card-Bz0DRxyr.js";import{D as de,a as me,b as ue}from"./dialog-DRhRae12.js";import{I as T}from"./input-C2ANQTP7.js";import{S as _,a as y,b as S,c as C,d as c}from"./select-D7HemE6b.js";import{T as $}from"./textarea-DRIBbhg2.js";import{F as he}from"./filter-xdm5Aca0.js";import{S as xe}from"./search-BCJGbozL.js";import{L as I}from"./loader-circle-BXz_mN7F.js";import{X as pe}from"./index-DDu-XsiY.js";import{C as je}from"./chevron-left-DDxKDEIa.js";import{C as fe}from"./chevron-right-9uhcl-nB.js";import{P as ge}from"./plus-D2S5AZUM.js";import{E as be}from"./eye-FWSCBQ3U.js";import"./index-Cl8-oniw.js";import"./index-CrYDax7T.js";import"./index-CI31nOew.js";import"./index-PEPdBG5A.js";import"./index-Cj3P2_NM.js";import"./index-BBmvays4.js";import"./index-RV60opQ8.js";import"./chevron-down-CcBmENhd.js";const Ne={Open:{label:"Open",className:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"},Closed:{label:"Closed",className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300"},"In Progress":{label:"In Progress",className:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300"}};function Xe({initialFilters:u={},subjectProblems:G}){var R;const[r,Q]=n.useState(null),[x,U]=n.useState(!1),[l,h]=n.useState({search:u.search||"",status:u.status||"all",subject_problem:u.subject_problem||"all",date_from:u.date_from||"",date_to:u.date_to||"",sort:u.sort||"created_at",direction:u.direction||"desc"}),[d,A]=n.useState(1),[v,W]=n.useState(15),[k,Y]=n.useState(!1),[D,Z]=n.useState(""),[ee,w]=n.useState(!1),[p,E]=n.useState(null),[m,g]=n.useState({priority:"medium",description:"",notes:""}),[O,M]=n.useState(!1),se=(s,t)=>{let a;return(...i)=>{clearTimeout(a),a=setTimeout(()=>{s.apply(null,i)},t)}},b=n.useCallback(async(s=1,t=l,a=!1)=>{var V;const i=new URLSearchParams;i.append("page",s.toString()),i.append("per_page",v.toString()),Object.entries(t).forEach(([f,N])=>{N&&N!=="all"&&i.append(f,String(N))});const j=i.toString();if(!(j===D&&!a)){U(!0),Z(j),A(s);try{const f=await fetch("/admin/maintenances/table-data",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((V=document.querySelector('meta[name="csrf-token"]'))==null?void 0:V.getAttribute("content"))||""},body:JSON.stringify(Object.fromEntries(i))});if(f.ok){const N=await f.json();Q(N)}else console.error("Failed to fetch maintenance data")}catch(f){console.error("Error fetching maintenance data:",f)}finally{U(!1)}}},[v,D,d]),te=n.useCallback(se((s,t)=>{b(s,t,!0)},300),[]);n.useEffect(()=>{b(1,l,!0)},[]),n.useEffect(()=>{r&&b(1,l,!0)},[v]),n.useEffect(()=>{r&&te(1,l)},[l]);const ae=s=>{s.preventDefault()},F=s=>{s>=1&&s<=((r==null?void 0:r.last_page)||1)&&b(s,l,!0)},re=s=>{const t=l.sort===s&&l.direction==="asc"?"desc":"asc";h(a=>({...a,sort:s,direction:t}))},le=()=>{h({search:"",status:"all",subject_problem:"all",date_from:"",date_to:"",sort:"created_at",direction:"desc"}),A(1)},ne=s=>{E(s),g({priority:"medium",description:"",notes:""}),w(!0)},ie=async s=>{var t;if(s.preventDefault(),!(!p||!m.description)){M(!0);try{(await fetch(route("admin.maintenances.create-follow-up",p.ticket_id),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},body:JSON.stringify({customer_id:p.customer_id,priority:m.priority,description:m.description,assigned_to:"unassigned",notes:m.notes||null})})).ok?(w(!1),E(null),g({priority:"medium",description:"",notes:""}),b(d,l,!0)):console.error("Failed to create follow up")}catch(a){console.error("Error creating follow up:",a)}finally{M(!1)}}},L=s=>{try{return new Date(s).toLocaleDateString("id-ID",{year:"numeric",month:"short",day:"numeric"})}catch{return"-"}},ce=({field:s})=>l.sort!==s?e.jsx("span",{className:"text-gray-400",children:"↕"}):l.direction==="asc"?e.jsx("span",{children:"↑"}):e.jsx("span",{children:"↓"}),z=(s,t=50)=>s?s.length>t?`${s.substring(0,t)}...`:s:"-",q=[{header:"Ticket ID",className:"min-w-[140px]",sortable:!0,render:s=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.ticket_id}),s.subscription_id&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Sub: ",s.subscription_id]})]})},{header:"Customer",className:"min-w-[180px]",sortable:!0,render:s=>{var t,a,i;return e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(t=s.customer)==null?void 0:t.customer_name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:(a=s.customer)==null?void 0:a.customer_email}),e.jsx("div",{className:"text-xs text-muted-foreground",children:(i=s.customer)==null?void 0:i.customer_phone})]})}},{header:"Subscription ID",sortable:!0,className:"min-w-[140px]",render:s=>{var t,a;return e.jsx("div",{className:"max-w-[140px] truncate",title:((t=s.subscription)==null?void 0:t.subscription_description)||"-",children:((a=s.subscription)==null?void 0:a.subscription_id)||"-"})}},{header:"Subject",className:"min-w-[180px]",sortable:!0,render:s=>e.jsx("div",{className:"max-w-[180px] truncate",title:s.subject_problem,children:s.subject_problem})},{header:"Report",className:"min-w-[200px]",render:s=>e.jsx("div",{className:"max-w-[200px] truncate",title:s.customer_report,children:z(s.customer_report,50)})},{header:"Technician Update",className:"min-w-[200px]",render:s=>e.jsx("div",{className:"max-w-[200px] truncate",title:s.technician_update_desc,children:z(s.technician_update_desc,50)})},{header:"Status",className:"min-w-[100px]",sortable:!0,render:s=>{const t=Ne[s.status];return e.jsx(B,{className:(t==null?void 0:t.className)||"bg-gray-100 text-gray-800",children:(t==null?void 0:t.label)||s.status})}},{header:"Follow Up",className:"min-w-[120px]",render:s=>{var t,a,i;return e.jsx("div",{className:"space-y-1",children:s.has_active_follow_ups?e.jsxs("div",{className:"space-y-1",children:[(t=s.active_follow_ups)==null?void 0:t.slice(0,2).map(j=>e.jsxs("div",{className:"text-xs",children:[e.jsx(B,{variant:"outline",className:"text-xs",children:j.priority}),e.jsxs("span",{className:"ml-1 text-muted-foreground",children:["(",j.status,")"]})]},j.id)),(((a=s.active_follow_ups)==null?void 0:a.length)||0)>2&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["+",(((i=s.active_follow_ups)==null?void 0:i.length)||0)-2," more"]})]}):e.jsxs(o,{size:"sm",variant:"default",onClick:()=>ne(s),className:"text-xs",children:[e.jsx(ge,{className:"mr-1 h-3 w-3"}),"Add Follow Up"]})})}},{header:"Created At",className:"min-w-[120px]",sortable:!0,render:s=>e.jsx("div",{className:"text-sm",children:L(s.created_at)})},{header:"Updated At",className:"min-w-[120px]",sortable:!0,render:s=>e.jsx("div",{className:"text-sm",children:L(s.updated_at)})},{header:"Actions",className:"min-w-[100px]",render:s=>e.jsx("div",{className:"flex gap-2",children:e.jsx("a",{href:route("admin.maintenances.show",s.ticket_id),children:e.jsx(o,{size:"sm",variant:"outline",children:e.jsx(be,{className:"h-4 w-4"})})})})}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx(H,{children:e.jsxs(X,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(J,{children:"Maintenance Management"}),e.jsx(K,{children:"Manage and track maintenance tickets"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>Y(!k),className:P("gap-2",k&&"bg-muted"),children:[e.jsx(he,{className:"h-4 w-4"}),"Filters"]})})]}),e.jsxs("form",{onSubmit:ae,className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(xe,{className:"absolute top-1/2 left-3 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(T,{placeholder:"Search by ticket ID, customer name, email or subject...",value:l.search,onChange:s=>h(t=>({...t,search:s.target.value})),className:"pl-9"})]}),e.jsx(o,{type:"submit",size:"sm",disabled:x,children:x?e.jsx(I,{className:"h-4 w-4 animate-spin"}):"Search"}),(l.search||l.status!=="all"||l.subject_problem!=="all"||l.date_from||l.date_to)&&e.jsxs(o,{type:"button",variant:"outline",size:"sm",onClick:le,children:[e.jsx(pe,{className:"h-4 w-4"}),"Clear"]})]}),k&&e.jsxs("div",{className:"grid grid-cols-1 gap-4 pt-4 md:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Status"}),e.jsxs(_,{value:l.status,onValueChange:s=>h(t=>({...t,status:s})),children:[e.jsx(y,{children:e.jsx(S,{placeholder:"All Status"})}),e.jsxs(C,{children:[e.jsx(c,{value:"all",children:"All Status"}),e.jsx(c,{value:"Open",children:"Open"}),e.jsx(c,{value:"Closed",children:"Closed"}),e.jsx(c,{value:"In Progress",children:"In Progress"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Subject Problem"}),e.jsxs(_,{value:l.subject_problem,onValueChange:s=>h(t=>({...t,subject_problem:s})),children:[e.jsx(y,{children:e.jsx(S,{placeholder:"All Problems"})}),e.jsxs(C,{children:[e.jsx(c,{value:"all",children:"All Problems"}),G.map(s=>e.jsx(c,{value:s,children:s},s))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Date From"}),e.jsx(T,{type:"date",value:l.date_from,onChange:s=>h(t=>({...t,date_from:s.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Date To"}),e.jsx(T,{type:"date",value:l.date_to,onChange:s=>h(t=>({...t,date_to:s.target.value}))})]})]})]})}),e.jsxs(H,{children:[e.jsx(X,{className:"pb-3",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Showing ",(r==null?void 0:r.from)||0," to ",(r==null?void 0:r.to)||0," of ",(r==null?void 0:r.total)||0," entries"]}),e.jsxs(_,{value:v.toString(),onValueChange:s=>W(parseInt(s)),children:[e.jsx(y,{className:"w-20",children:e.jsx(S,{})}),e.jsxs(C,{children:[e.jsx(c,{value:"15",children:"15"}),e.jsx(c,{value:"25",children:"25"}),e.jsx(c,{value:"50",children:"50"}),e.jsx(c,{value:"100",children:"100"})]})]})]})})}),e.jsx(oe,{className:"p-0",children:e.jsxs("div",{className:"relative",children:[x&&e.jsx("div",{className:"absolute inset-0 z-10 flex items-center justify-center bg-background/50",children:e.jsx(I,{className:"h-8 w-8 animate-spin"})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsx("tr",{className:"border-b",children:q.map((s,t)=>e.jsx("th",{className:P("p-3 text-left font-medium",s.className,s.sortable&&"cursor-pointer hover:bg-muted/50"),onClick:()=>s.sortable&&re(s.header.toLowerCase().replace(" ","_")),children:e.jsxs("div",{className:"flex items-center gap-1",children:[s.header,s.sortable&&e.jsx(ce,{field:s.header.toLowerCase().replace(" ","_")})]})},t))})}),e.jsx("tbody",{children:r==null?void 0:r.data.map((s,t)=>e.jsx("tr",{className:"border-b hover:bg-muted/50",children:q.map((a,i)=>e.jsx("td",{className:P("p-3",a.className),children:a.render(s)},i))},t))})]})})]})})]}),r&&r.last_page>1&&e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>F(d-1),disabled:d<=1||x,children:[e.jsx(je,{className:"h-4 w-4"}),"Previous"]}),e.jsx("div",{className:"flex gap-1",children:[...Array(Math.min(5,r.last_page))].map((s,t)=>{const a=Math.max(1,Math.min(r.last_page-4,Math.max(1,d-2)))+t;return a<=r.last_page?e.jsx(o,{variant:d===a?"default":"outline",size:"sm",onClick:()=>F(a),disabled:x,className:"min-w-[40px]",children:a},a):null})}),e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>F(d+1),disabled:d>=r.last_page||x,children:["Next",e.jsx(fe,{className:"h-4 w-4"})]})]}),e.jsx(de,{open:ee,onOpenChange:w,children:e.jsxs(me,{className:"max-w-md",children:[e.jsxs(ue,{children:[e.jsx(J,{children:"Add Follow Up"}),e.jsxs(K,{children:["Create a follow up for ",(R=p==null?void 0:p.customer)==null?void 0:R.customer_name]})]}),e.jsxs("form",{onSubmit:ie,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Priority"}),e.jsxs(_,{value:m.priority,onValueChange:s=>g(t=>({...t,priority:s})),children:[e.jsx(y,{children:e.jsx(S,{placeholder:"Select priority"})}),e.jsxs(C,{children:[e.jsx(c,{value:"low",children:"Low"}),e.jsx(c,{value:"medium",children:"Medium"}),e.jsx(c,{value:"high",children:"High"}),e.jsx(c,{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Description *"}),e.jsx($,{value:m.description,onChange:s=>g(t=>({...t,description:s.target.value})),placeholder:"Describe the follow up requirement...",className:"min-h-[100px]",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Notes"}),e.jsx($,{value:m.notes,onChange:s=>g(t=>({...t,notes:s.target.value})),placeholder:"Any additional notes...",className:"min-h-[80px]"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(o,{type:"button",variant:"outline",onClick:()=>w(!1),children:"Cancel"}),e.jsxs(o,{type:"submit",disabled:O||!m.description,children:[O?e.jsx(I,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Create Follow Up"]})]})]})]})})]})}export{Xe as default};
